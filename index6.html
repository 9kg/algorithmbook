<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

    </head>
    <body>

        <script>

            function tryDecodeURIComponent(value) {
                try {
                    return decodeURIComponent(value);
                } catch (e) {
                    return value
                }
            }

            function addProperty(host, key, value, isArray) {
                if (isArray) {
                    if (key === "") {
                        try {
                            host.push(value)
                        } catch (e) {
                            console.log(arguments)
                        }
                    } else {
                        host[key >>> 0] = value
                    }
                } else {
                    host[tryDecodeURIComponent(key)] = value
                }
            }
            var rbracket = /%5B(.*?)%5D$/;
            //a%5B0%5D%5Bvalue%5D a%5B1%5D%5B%5D
            function addSubObject(host, text, value) {
                var match = text.match(rbracket)
                if (!match) {
                    return true
                }
                console.log("===============================")
                var steps = []
                var first = true
                var step, index, key
                while (index = text.lastIndexOf("%5B")) {
                    if (index === -1) {
                        break
                    }
                    key = text.slice(index).slice(3, -3)
                    text = text.slice(0, index)
                    if (key === "") {
                        steps.unshift({
                            action: "pushArrayElement"
                        })
                    } else if ((key >>> 0) + "" === key) {
                        steps.unshift({
                            action: "setSubArray",
                            value: key
                        })
                    } else {
                        if (first) {
                            steps.unshift({
                                action: "setObjectProperty",
                                value: tryDecodeURIComponent(key)
                            })
                        } else {
                            steps.unshift({
                                action: "setSubObjet",
                                value: tryDecodeURIComponent(key)
                            })
                        }
                    }
                    first = false
                }
                 first = true
                while (step = steps.shift()) {
                    var isObject = /Object/.test(step.action)
                    if (first) {
                        if (!(text in host)) {
                            host[text] = isObject ? {} : []
                        }
                        first = false
                        host = host[text]
                    }
                    switch (step.action) {
                        case "pushArrayElement":
                            host.push(value)
                            break
                        case "setObjectProperty":
                            host[step.value] = value
                            break
                        case "setSubObjet":
                            if (!(step.value in host)) {
                                host[step.value] = {}
                            }
                            host = host[step.value]
                            break
                        case "setSubArray":
                            if (!(step.value in host)) {
                                host[step.value] = []
                            }
                            host = host[step.value]
                            break
                    }
                }
            }
            //  function add
            function queryToJson(qs, sep, eq) {
                sep = sep || '&';
                eq = eq || '=';
                var obj = {};
                if ((typeof qs !== "string") || qs.length === 0) {
                    return obj;
                }
                var array = qs.split(sep);
                for (var i = 0, el; el = array[i++]; ) {
                    var arr = el.split("=")
                    if (arr.length === 1) {//处理只有键名没键值的情况
                        obj[arr[0]] = void 0
                    } else {
                        var key = arr[0]
                        var v = tryDecodeURIComponent(arr.slice(1).join("=").replace(/\+/g, ' '));
                        if (addSubObject(obj, key, v)) { //处理存在中括号的情况
                            var k = tryDecodeURIComponent(key) //处理不存在中括号的简单的情况
                            if (!Object.prototype.hasOwnProperty.call(obj, k)) {
                                obj[k] = v;
                            } else if (Array.isArray(obj[k])) {
                                obj[k].push(v);
                            } else {
                                obj[k] = [obj[k], v];
                            }
                        }
                    }
                }
                console.log(obj)
                return obj
            }



            //    queryToJson("foo%5B%5D=baz&foo%5B%5D=42&foo%5B%5D=All+your+base+are+belong+to+us")

            //    queryToJson("someName%5B%5D=1&someName%5B%5D=2&someName%5B%5D=3&regularThing=blah")

            //   queryToJson("foo%5B%5D=a&foo%5B%5D=b&foo%5B%5D=c")

            //  queryToJson("foo%5Bbar%5D=baz&foo%5Bbeep%5D=42&foo%5Bquux%5D=All+your+base+are+belong+to+us")
// {"a": [0, [1, 2], [3, 4, 5] ]}
            //   queryToJson("a%5B%5D=0&a%5B1%5D%5B%5D=1&a%5B1%5D%5B%5D=2&a%5B2%5D%5B%5D=3&a%5B2%5D%5B%5D=4&a%5B2%5D%5B%5D=5")
            // {"a": [0, [1, 2], [3, 4, [5,6]] ]}
            //queryToJson("a%5B%5D=0&a%5B1%5D%5B%5D=1&a%5B1%5D%5B%5D=2&a%5B2%5D%5B%5D=3&a%5B2%5D%5B%5D=4&a%5B2%5D%5B2%5D%5B%5D=5&a%5B2%5D%5B2%5D%5B%5D=6")

            queryToJson("a%5B0%5D%5Bvalue%5D=1&a%5B1%5D%5Bvalue%5D=2")
        </script>
    </body>
</html>
